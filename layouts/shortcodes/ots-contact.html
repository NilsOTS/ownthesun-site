<section class="form-wrap">
  <!-- Kopftext -->
  <p class="minihead">Premium-Produkte mit extra langer Garantie & persönlicher Beratung.</p>
  <p class="minihead">
    Persönliche Beratung für Hamburg & Schleswig-Holstein.<br>
    <strong>Wir melden uns i.d.R. binnen 24h.</strong>
  </p>

  <form id="ots-contact" class="ots-form" method="post" action="https://automation.ownthesun.de/webhook/lead" novalidate>
    <!-- Anti-Spam (Honeypot: muss leer bleiben) -->
    <input type="text" name="website" class="hp" tabindex="-1" autocomplete="off" aria-hidden="true">

    <!-- Metadaten (werden per JS gesetzt) -->
    <input type="hidden" name="form_version" value="qs-v1">
    <input type="hidden" name="submitted_at" value="">
    <input type="hidden" name="page_url" value="">
    <input type="hidden" name="utm_source" value="">
    <input type="hidden" name="utm_campaign" value="">
    <input type="hidden" name="utm_medium" value="">

    <!-- Namen -->
    <fieldset class="grid-2">
      <div class="field">
        <label for="fname">Vorname*</label>
        <input id="fname" name="first_name" type="text" required inputmode="text" autocomplete="given-name">
      </div>
      <div class="field">
        <label for="lname">Nachname*</label>
        <input id="lname" name="last_name" type="text" required inputmode="text" autocomplete="family-name">
      </div>
    </fieldset>

    <!-- Kontakt -->
    <fieldset class="grid-2">
      <div class="field">
        <label for="email">E-Mail*</label>
        <input id="email" name="email" type="email" required autocomplete="email">
      </div>
      <div class="field">
        <label for="phone">Telefon*</label>
        <input id="phone" name="phone" type="tel" required inputmode="tel" autocomplete="tel">
      </div>
    </fieldset>

    <!-- Adresse: Straße vor PLZ/Ort und Pflichtfeld -->
    <fieldset class="grid-1">
      <div class="field">
        <label for="street">Straße & Nr.*</label>
        <input id="street" name="street" type="text" required autocomplete="address-line1">
      </div>
    </fieldset>

    <fieldset class="grid-2">
      <div class="field">
        <label for="zip">PLZ*</label>
        <input id="zip" name="zip" type="text" required pattern="[0-9]{5}" inputmode="numeric">
      </div>
      <div class="field">
        <label for="city">Ort*</label>
        <input id="city" name="city" type="text" required>
      </div>
    </fieldset>

    <!-- Interessen -->
    <fieldset class="grid-1">
      <legend>Wofür interessieren Sie sich?*</legend>
      <div class="checklist">
        <div class="opt"><input id="int-pv"       type="checkbox" name="interest[]" value="pv"       required><label for="int-pv">Photovoltaik</label></div>
        <div class="opt"><input id="int-speicher" type="checkbox" name="interest[]" value="speicher"><label for="int-speicher">Stromspeicher</label></div>
        <div class="opt"><input id="int-wp"       type="checkbox" name="interest[]" value="wp"><label for="int-wp">Wärmepumpe</label></div>
        <div class="opt"><input id="int-wallbox"  type="checkbox" name="interest[]" value="wallbox"><label for="int-wallbox">Wallbox</label></div>
        <div class="opt"><input id="int-ems"      type="checkbox" name="interest[]" value="ems"><label for="int-ems">Energiemanagement</label></div>
      </div>
    </fieldset>

    <!-- Nachricht -->
    <fieldset class="grid-1">
      <div class="field">
        <label for="message">Kurze Beschreibung (optional)</label>
        <textarea id="message" name="message" rows="4" placeholder="Dachform, Baujahr, Stromverbrauch, Ziele…"></textarea>
      </div>
    </fieldset>

    <!-- Einwilligungen -->
    <fieldset class="grid-1 consents">
      <div class="opt">
        <input id="c-legal" type="checkbox" name="legal_accept" value="yes" required>
        <label for="c-legal">Ich akzeptiere die <a href="/datenschutz/" target="_blank" rel="noopener">Datenschutzbestimmungen</a> und
        <a href="/nutzungsbedingungen/" target="_blank" rel="noopener">Nutzungsbedingungen</a>.*</label>
      </div>

      <div class="opt">
        <input id="c-partner" type="checkbox" name="partner_share_optin" value="yes">
        <label for="c-partner">Optional: Ich erlaube die Weitergabe meiner Anfrage an ausgewählte, geprüfte Fachpartner in meiner Region (widerruflich).</label>
      </div>

      <div class="opt">
        <input id="c-marketing" type="checkbox" name="consent_marketing" value="yes">
        <label for="c-marketing">Optional: Ich möchte Updates & Angebote per E-Mail erhalten (widerruflich).</label>
      </div>
    </fieldset>

    <div class="actions">
      <button type="submit" class="cta-button">Kostenfreie Erstberatung absenden</button>
      <p class="legal-hint">*Pflichtfelder</p>
    </div>
  </form>

  <div id="form-status" class="form-status" aria-live="polite"></div>

  <!-- Styles nur für dieses Formular -->
  <style>
    .form-wrap { max-width: 740px; margin: 0 auto; }
    .minihead { text-align:center; margin:8px 0 4px; }
    .hp { display:none !important; }

    /* Grid für Felder */
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .grid-1 { display:block; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:.92rem; color:#0a2942; }
    .field input, .field textarea { width:100%; padding:.6rem .7rem; border:1px solid #cfd8df; border-radius:4px; }

    /* Checklisten/Einwilligungen – Checkbox links, Text direkt daneben */
    .checklist, .consents { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .opt { display:flex !important; align-items:flex-start !important; gap:12px; }
    .opt input { appearance:auto; position:static !important; margin-top:3px !important; }
    .opt label { all:unset; display:block; flex:1 1 auto; line-height:1.35; color:inherit; cursor:pointer; }
    .opt label a { text-decoration:underline; }

    .actions { text-align:center; margin-top:10px; }
    .cta-button { padding:.75rem 1.25rem; border:1px solid #0a2942; background:#0a2942; color:#fff; border-radius:6px; }
    .cta-button:hover { filter:brightness(.95); }
    .legal-hint { font-size:.85rem; color:#6b7c8a; }

    @media (max-width: 760px) {
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>

  <!-- Logik: Metadaten setzen & senden -->
  <script>
  (function () {
    const f = document.getElementById('ots-contact');
    const status = document.getElementById('form-status');

    // Metadaten
    f.querySelector('[name="submitted_at"]').value = new Date().toISOString();
    f.querySelector('[name="page_url"]').value = window.location.href;
    const usp = new URLSearchParams(window.location.search);
    ['utm_source','utm_campaign','utm_medium'].forEach(k=>{
      const v = usp.get(k);
      if (v) f.querySelector(`[name="${k}"]`).value = v;
    });

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = "Sende…";
      const data = new FormData(f);
      try {
        const res = await fetch(f.action, { method:'POST', body: data, headers:{'Accept':'application/json'} });
        if (res.ok) {
          // Erfolgs-Redirect (falls n8n 302 setzt, folgen wir Location; sonst feste Danke-Seite)
          if (res.redirected) {
            window.location.href = res.url;
          } else {
            window.location.href = "/danke/";
          }
        } else {
          status.textContent = "Fehler beim Senden. Bitte erneut versuchen.";
        }
      } catch(err) {
        status.textContent = "Netzwerkfehler. Bitte später erneut versuchen.";
      }
    });
  })();
  </script>
</section>
