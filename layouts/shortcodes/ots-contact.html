<section class="form-wrap">
    <p class="infos">Persönliche Beratung für Hamburg & Schleswig-Holstein.<br>Wir melden uns i.d.R. <strong>binnen 24h</strong>.</p>

  <form id="ots-contact" class="ots-form" method="post" action="https://automation.ownthesun.de/webhook/lead" novalidate>
    <!-- Honeypot -->
    <input type="text" name="website" class="hp" tabindex="-1" autocomplete="off" aria-hidden="true">

    <!-- Metadaten -->
    <input type="hidden" name="form_version" value="qs-v1">
    <input type="hidden" name="submitted_at" value="">
    <input type="hidden" name="page_url" value="">
    <input type="hidden" name="utm_source" value="">
    <input type="hidden" name="utm_campaign" value="">
    <input type="hidden" name="utm_medium" value="">

    <!-- Name -->
    <fieldset class="grid-2">
      <div class="field row">
        <label for="fname">Vorname*</label>
        <input id="fname" name="first_name" type="text" required inputmode="text" autocomplete="given-name">
      </div>
      <div class="field row">
        <label for="lname">Nachname*</label>
        <input id="lname" name="last_name" type="text" required inputmode="text" autocomplete="family-name">
      </div>
    </fieldset>

    <!-- Kontakt -->
    <fieldset class="grid-2">
      <div class="field row">
        <label for="email">E-Mail*</label>
        <input id="email" name="email" type="email" required autocomplete="email">
      </div>
      <div class="field row">
        <label for="phone">Telefon*</label>
        <input id="phone" name="phone" type="tel" required inputmode="tel" autocomplete="tel">
      </div>
    </fieldset>

    <!-- Straße (Pflicht, ÜBER PLZ/Ort) -->
    <fieldset class="grid-1">
      <div class="field row">
        <label for="street">Straße & Nr.*</label>
        <input id="street" name="street" type="text" required autocomplete="address-line1">
      </div>
    </fieldset>

    <!-- PLZ / Ort -->
    <fieldset class="grid-2">
      <div class="field row">
        <label for="zip">PLZ*</label>
        <input id="zip" name="zip" type="text" required pattern="[0-9]{5}" inputmode="numeric">
      </div>
      <div class="field row">
        <label for="city">Ort*</label>
        <input id="city" name="city" type="text" required>
      </div>
    </fieldset>

    <!-- Interessen -->
    <fieldset class="grid-1">
      <legend>Wofür interessieren Sie sich?*</legend>
      <div class="checklist">
        <label class="opt"><input type="checkbox" name="interest[]" value="pv" required> <span>Photovoltaik</span></label>
        <label class="opt"><input type="checkbox" name="interest[]" value="speicher"> <span>Stromspeicher</span></label>
        <label class="opt"><input type="checkbox" name="interest[]" value="wp"> <span>Wärmepumpe</span></label>
        <label class="opt"><input type="checkbox" name="interest[]" value="wallbox"> <span>Wallbox</span></label>
        <label class="opt"><input type="checkbox" name="interest[]" value="ems"> <span>Energiemanagement</span></label>
      </div>
    </fieldset>

    <!-- Nachricht -->
    <fieldset class="grid-1">
      <div class="field row row-textarea">
        <label for="message">Kurze Beschreibung (optional)</label>
        <textarea id="message" name="message" rows="5" placeholder="Dachform, Baujahr, Stromverbrauch, Ziele..."></textarea>
      </div>
    </fieldset>

    <!-- Einwilligungen -->
    <fieldset class="grid-1 consents">
      <label class="opt">
        <input type="checkbox" name="legal_accept" value="yes" required>
        <span>Ich akzeptiere die <a href="/datenschutz/" target="_blank" rel="noopener">Datenschutzbestimmungen</a> und
        <a href="/nutzungsbedingungen/" target="_blank" rel="noopener">Nutzungsbedingungen</a>.*</span>
      </label>
      <label class="opt">
        <input type="checkbox" name="partner_share_optin" value="yes">
        <span>Optional: Ich erlaube die Weitergabe meiner Anfrage an ausgewählte, geprüfte Fachpartner in meiner Region (widerruflich).</span>
      </label>
      <label class="opt">
        <input type="checkbox" name="consent_marketing" value="yes">
        <span>Optional: Ich möchte Updates & Angebote per E-Mail erhalten (widerruflich).</span>
      </label>
    </fieldset>

    <div class="actions">
      <button type="submit" class="cta-button">Kostenfreie Erstberatung absenden</button>
      <p class="legal-hint">*Pflichtfelder</p>
    </div>
  </form>

  <div id="form-status" class="form-status" aria-live="polite"></div>
</section>

<style>
  /* ===== Reset innerhalb des Formularbereichs (verhindert Theme-Floats etc.) ===== */
  .form-wrap *{box-sizing:border-box}
  .form-wrap label{float:none !important; width:auto !important; display:initial !important; margin:0}
  .form-wrap fieldset{border:1px solid var(--c-border, #d9e1e8); padding:10px 12px; margin:0}
  .form-wrap legend{margin:0 0 6px 0; padding:0}

  /* Texte zentrieren */
  .sublead,.infos{text-align:center;margin:0 0 8px 0}

  /* Formular-Raster */
  .ots-form{display:grid;gap:14px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-1{display:block}

  /* Zeilenlayout: Label links, Feld rechts in EINER Linie */
  .row{display:grid !important; grid-template-columns:170px 1fr !important; column-gap:12px; align-items:center !important}
  .row input,.row textarea{width:100%}

  /* Textarea-Ausrichtung */
  .row-textarea{align-items:start}
  .row-textarea label{padding-top:6px}
  .row textarea{min-height:110px;resize:vertical}

  /* Checklisten & Einwilligungen: Checkbox links, Text daneben; alles innerhalb der Box */
  .checklist,.consents{display:block}
  .checklist .opt,.consents .opt{
    display:flex !important; align-items:flex-start !important; gap:10px;
    margin:0; padding:4px 0; width:100%;
  }
  .checklist .opt input,.consents .opt input{margin-top:2px; flex:0 0 auto}
  .checklist .opt span,.consents .opt span{
    flex:1 1 auto; display:block; white-space:normal; overflow-wrap:anywhere; word-break:break-word;
  }

  /* Button-Zeile */
  .actions{text-align:center;margin-top:6px}

  /* Honeypot unsichtbar */
  .hp{position:absolute !important; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}
</style>

<script>
  (function () {
    const f = document.getElementById('ots-contact');
    const status = document.getElementById('form-status');
    if (!f) return;

    // Metadaten setzen
    f.querySelector('[name="submitted_at"]').value = new Date().toISOString();
    f.querySelector('[name="page_url"]').value = window.location.href;
    const usp = new URLSearchParams(window.location.search);
    ['utm_source','utm_campaign','utm_medium'].forEach(k=>{
      const v = usp.get(k);
      if (v) f.querySelector(`[name="${k}"]`).value = v;
    });

    // Senden
    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = "Sende...";
      const data = new FormData(f);
      try {
        const res = await fetch(f.action, { method: 'POST', body: data, headers: { 'Accept': 'application/json' } });
        if (res.ok) window.location.href = "/kontakt/thank-you/";
        else status.textContent = "Fehler beim Senden. Bitte erneut versuchen.";
      } catch (err) {
        status.textContent = "Netzwerkfehler. Bitte später erneut versuchen.";
      }
    });
  })();
</script>
