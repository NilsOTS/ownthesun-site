<section class="form-wrap">
  <p class="lead" style="text-align:center;">
    Persönliche, professionelle Beratung für Hamburg &amp; Schleswig-Holstein.<br>
    <strong>Wir melden uns i.d.R. binnen 24h.</strong>
  </p>

  <form id="ots-contact" class="ots-form" method="post" action="https://automation.ownthesun.de/webhook/lead" novalidate>
    <!-- Anti-Spam (Honeypot: muss leer bleiben) -->
    <input type="text" name="website" class="hp" tabindex="-1" autocomplete="off" aria-hidden="true">

    <!-- Metadaten (werden per JS befüllt) -->
    <input type="hidden" name="form_version" value="qs-v1">
    <input type="hidden" name="submitted_at" value="">
    <input type="hidden" name="page_url" value="">
    <input type="hidden" name="utm_source" value="">
    <input type="hidden" name="utm_campaign" value="">
    <input type="hidden" name="utm_medium" value="">

    <!-- Name -->
    <fieldset class="grid-2">
      <div class="field">
        <label for="fname">Vorname*</label>
        <input id="fname" name="first_name" type="text" required inputmode="text" autocomplete="given-name">
      </div>
      <div class="field">
        <label for="lname">Nachname*</label>
        <input id="lname" name="last_name" type="text" required inputmode="text" autocomplete="family-name">
      </div>
    </fieldset>

    <!-- Kontakt -->
    <fieldset class="grid-2">
      <div class="field">
        <label for="email">E-Mail*</label>
        <input id="email" name="email" type="email" required autocomplete="email">
      </div>
      <div class="field">
        <label for="phone">Telefon*</label>
        <input id="phone" name="phone" type="tel" required inputmode="tel" autocomplete="tel">
      </div>
    </fieldset>

    <!-- Adresse: Straße vor PLZ/Ort -->
    <fieldset class="grid-1">
      <div class="field">
        <label for="street">Straße &amp; Nr.*</label>
        <input id="street" name="street" type="text" required autocomplete="address-line1">
      </div>
    </fieldset>

    <fieldset class="grid-2">
      <div class="field">
        <label for="zip">PLZ*</label>
        <input id="zip" name="zip" type="text" required pattern="[0-9]{5}" inputmode="numeric">
      </div>
      <div class="field">
        <label for="city">Ort*</label>
        <input id="city" name="city" type="text" required>
      </div>
    </fieldset>

    <!-- Interessen -->
    <fieldset class="choices" aria-labelledby="interest-legend">
      <legend id="interest-legend">Wofür interessieren Sie sich?*</legend>

      <label class="opt"><input type="checkbox" name="interest[]" value="pv" required><span>Photovoltaik</span></label>
      <label class="opt"><input type="checkbox" name="interest[]" value="speicher"><span>Stromspeicher</span></label>
      <label class="opt"><input type="checkbox" name="interest[]" value="wp"><span>Wärmepumpe</span></label>
      <label class="opt"><input type="checkbox" name="interest[]" value="wallbox"><span>Wallbox</span></label>
      <label class="opt"><input type="checkbox" name="interest[]" value="ems"><span>Energiemanagement</span></label>
    </fieldset>

    <!-- Nachricht -->
    <fieldset class="grid-1">
      <div class="field">
        <label for="message">Kurze Beschreibung (optional)</label>
        <textarea id="message" name="message" rows="4" placeholder="Dachform, Baujahr, Stromverbrauch, Ziele..."></textarea>
      </div>
    </fieldset>

    <!-- Einwilligungen -->
    <fieldset class="choices">
      <label class="opt">
        <input type="checkbox" name="legal_accept" value="yes" required>
        <span>
          Ich akzeptiere die
          <a href="/datenschutz/" target="_blank" rel="noopener">Datenschutzbestimmungen</a>
          und
          <a href="/nutzungsbedingungen/" target="_blank" rel="noopener">Nutzungsbedingungen</a>.*
        </span>
      </label>

      <label class="opt">
        <input type="checkbox" name="partner_share_optin" value="yes">
        <span>
          Optional: Ich erlaube die Weitergabe meiner Anfrage an ausgewählte, geprüfte Fachpartner in meiner Region (widerruflich).
        </span>
      </label>

      <label class="opt">
        <input type="checkbox" name="consent_marketing" value="yes">
        <span>
          Optional: Ich möchte Updates &amp; Angebote per E-Mail erhalten (widerruflich).
        </span>
      </label>
    </fieldset>
<!-- Rechtlicher Hinweis -->
<p class="legal-note" role="note">
  <strong>Hinweis:</strong> Ihre Anfrage zu Photovoltaik- und Speicherlösungen wird im Rahmen meiner Tätigkeit als
  selbstständiger Handelsvertreter (§§ 84 ff. HGB) an die Energiekonzepte Deutschland GmbH (EKD-Solar) weitergeleitet.
  Vertragspartner für Photovoltaik- und Speicherlösungen ist ausschließlich EKD-Solar.
</p>

    <div class="actions" style="text-align:center;">
      <button type="submit" class="cta-button">Kostenfreie Erstberatung absenden</button>
      <p class="legal-hint">*Pflichtfelder</p>
    </div>
  </form>

  <div id="form-status" class="form-status" aria-live="polite"></div>
</section>

<!-- STYLES: Label links / Feld rechts + Checkbox-Blöcke + Honeypot verstecken -->
<style>
  /* Honeypot zuverlässig verstecken */
  .ots-form .hp{ display:none !important; }

  /* Zwei Spalten anlegen */
  .ots-form fieldset.grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
    margin:12px 0;
  }
  .ots-form fieldset.grid-1{ margin:12px 0; }

  /* Label LINKS, Input RECHTS – auf einer Höhe */
  .ots-form .field{
    display:flex;
    align-items:center;
    gap:12px;
    width:100%;
  }
  .ots-form .field label{
    flex:0 0 140px;     /* feste Labelbreite */
    margin:0;
    text-align:left;
    white-space:nowrap;
  }
  .ots-form .field input,
  .ots-form .field textarea,
  .ots-form .field select{
    flex:1 1 auto;      /* Feld nimmt restliche Breite */
    width:100%;
  }

  /* Checkbox-Gruppen (Interessen / Einwilligungen) */
  .ots-form fieldset.choices{
    border:1px solid var(--border, #d9e2ea);
    padding:14px 16px;
    margin:12px 0;
    text-align:left;
  }
  .ots-form fieldset.choices legend{
    font-weight:600;
    margin:0 0 8px 0;
  }
  .ots-form .choices label.opt{
    display:flex;
    align-items:center;
    gap:3ch;            /* ≈ “3 Leerzeichen” Abstand */
    line-height:1.4;
  }
  .ots-form .choices label.opt + label.opt{ margin-top:8px; }
  .ots-form .choices input[type="checkbox"]{
    inline-size:18px;
    block-size:18px;
    margin:0;
  }

  /* Mobile: Labels oberhalb der Felder, damit es nicht quetscht */
  @media (max-width: 640px){
    .ots-form fieldset.grid-2{ grid-template-columns: 1fr; }
    .ots-form .field{ flex-direction:column; align-items:flex-start; }
    .ots-form .field label{ flex:none; }
  }
</style>

<script>
(function () {
  const f = document.getElementById('ots-contact');
  const status = document.getElementById('form-status');

  // Metadaten setzen
  f.querySelector('[name="submitted_at"]').value = new Date().toISOString();
  f.querySelector('[name="page_url"]').value = window.location.href;
  const usp = new URLSearchParams(window.location.search);
  ['utm_source','utm_campaign','utm_medium'].forEach(k=>{
    const v = usp.get(k);
    if (v) f.querySelector(`[name="${k}"]`).value = v;
  });

  f.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.textContent = "Sende...";
    const data = new FormData(f);
    try {
      const res = await fetch(f.action, { method: 'POST', body: data, headers: { 'Accept': 'application/json' } });
      if (res.ok) {
        window.location.href = "/kontakt/thank-you/";
      } else {
        status.textContent = "Fehler beim Senden. Bitte erneut versuchen.";
      }
    } catch (err) {
      status.textContent = "Netzwerkfehler. Bitte später erneut versuchen.";
    }
  });
})();
</script>
